---
import Layout from "./Layout.astro";
import { getCollection } from "astro:content";
import SidebarItem from "./SidebarItem.astro";
import type { NavFolder } from '../types';

interface Props {
  title?: string;
  description?: string;
}

const docs = await getCollection("docs");

const rootFolder: NavFolder = {
  type: 'folder',
  title: "Documentation",
  children: [],
};
docs.forEach((doc) => {
  const parts = doc.id.split("/");
  let currentFolder = rootFolder;

  parts.forEach((part, index) => {
    const isLastPart = index === parts.length - 1;
    if (isLastPart) {
      // It's a file
      currentFolder.children.push({
        type: 'link',
        title: doc.data.title,
        href: `/docs/${doc.id}`,
      });
    } else {
      // It's a folder
      const newTitle = part
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");

      let nextFolder = currentFolder.children.find(
        (child) => child.type === 'folder' && child.title === newTitle
      ) as NavFolder | undefined;

      if (!nextFolder) {
        nextFolder = { type: 'folder', title: newTitle, children: [] };
        currentFolder.children.push(nextFolder);
      }

      currentFolder = nextFolder;
    }
  });
});


const { title } = Astro.props;
---

<Layout title={title} description={Astro.props.description}>
  <div class="columns p-0 m-0" style="min-height: 100vh;">
    <aside class="column is-3 is-narrow-mobile is-fullheight px-5 py-5" style="background-color: var(--bulma-scheme-main-bis);">
      <aside class="menu">
        <p class="menu-label">Documentation</p>
        <ul class="menu-list">
          {rootFolder.children.map((item) => (
            <SidebarItem item={item} />
          ))}
        </ul>
      </aside>
    </aside>
    <main class="column section">
      <div class="container content is-medium">
        <slot />
      </div>
    </main>
  </div>
</Layout>
